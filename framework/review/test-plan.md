# План тестирования — AmazonSender

## 1) Цели
- Проверить корректность разовой отправки по базе.
- Убедиться, что тестовый режим работает и допускает повторные отправки.
- Проверить обработку bounce/complaint/delivery и отписок.
- Проверить запись отчётов и ошибок в Notion и CSV.
- Проверить валидацию подписи Notion webhook (`X-Notion-Signature`).

## 2) Область охвата
- API эндпоинты: `/send-mailout`, `/unsubscribe`, `/ses-events`.
- Интеграции: Notion, Supabase, SES, SNS.
- Rate limiting и retry.

## 3) Типы тестов
- Unit: конвертация контента, генерация footer, парсинг TEST_EMAILS, валидация подписи вебхука.
- Integration: Notion ↔ Supabase ↔ SES (моки).
- E2E: тестовая рассылка на TEST_EMAILS.

## 4) Критические сценарии
1) Отправка не‑тестовой рассылки → статус `Send`, отчёт в Notion, ошибок нет.
2) Повторный запуск той же рассылки (не тест) → отправка не происходит.
3) Тестовый режим → отправка только на TEST_EMAILS, допускает повтор.
4) SNS Bounce → статус подписчика `bounced`.
5) SNS Complaint → статус подписчика `unsubscribed`.
6) SNS Delivery → увеличение delivered_count.
7) /unsubscribe → статус подписчика `unsubscribed`.

## 5) Негативные кейсы
- Нет доступа к Supabase/SES → рассылка останавливается, статус Failed.
- Ошибка Notion API → запись в таблицу ошибок.
- Некорректный auth_token → 401/403.
- Пустой список активных подписчиков → корректный отчёт без отправки.

## 6) Критерии приёмки
- Нет дублей писем (кроме теста).
- Статусы подписчиков корректно обновляются.
- Отчёт и ошибки фиксируются в Notion.

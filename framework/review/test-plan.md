# План тестирования — AmazonSender

## 0) Источники и предположения
- Источники: `framework/docs/definition-of-done-ru.md`, `framework/docs/orchestrator-plan-ru.md`, `spec_001.md`.
- `docs/tech-spec-ru.md` отсутствует — использована `spec_001.md` как ТЗ (см. раздел «Пробелы»).
- `framework/review/review-brief.md` и `framework/review/handoff.md` не заполнены — команды запуска/окружение/commit неизвестны.

## 1) Цели
- Проверить корректность одноразовой отправки mailout (идемпотентность/блокировка повторной отправки).
- Убедиться, что тестовый режим (is_test/TEST_EMAILS) работает и допускает повторные отправки.
- Проверить обработку bounce/complaint/delivery и отписок.
- Проверить запись отчётов и ошибок в Notion и CSV.
- Проверить валидацию подписи Notion webhook (`X-Notion-Signature`) и SNS подписи.
- Проверить rate limiting, batch size и соблюдение лимитов SES.

## 2) Область охвата
- API эндпоинты: `/send-mailout`, `/unsubscribe`, `/ses-events`.
- Интеграции: Notion, Supabase, SES, SNS.
- Rate limiting и retry/обработка ошибок.
- Хранилище состояния: `subscribers`, `mailouts` (или эквивалентное хранение в Notion, если применяется).
- Логирование: Notion «Ошибки», CSV по рассылке, технические логи.

## 2.1) Вне области
- Настройка Notion UI и шаблонов писем.
- Канонический HTML‑шаблон и юридический текст (CAN‑SPAM).
- Маркетинговая логика (сегменты, триггеры, аналитика).

## 3) Типы тестов
- Unit: конвертация контента, генерация footer, парсинг TEST_EMAILS, валидация подписи вебхука.
- Integration: Notion ↔ Supabase ↔ SES (моки).
- E2E: тестовая рассылка на TEST_EMAILS.
- Manual: проверка Notion таблиц, логов, CSV, UI‑статусов.

## 4) Критические сценарии
1) Отправка не‑тестовой рассылки → статус в Notion = `Send`, `sent_at` заполнен, отчёт в Notion, ошибок нет.
2) Повторный запуск той же рассылки (не тест) → 409 Conflict и отсутствие повторной отправки.
3) Тестовый режим → отправка только на TEST_EMAILS, допускает повтор.
4) SNS Bounce → статус подписчика `bounced`, фиксация причины (bounce_type/subtype).
5) SNS Complaint → статус подписчика `unsubscribed`.
6) SNS Delivery → фиксация доставки/метрик (если реализовано).
7) /unsubscribe → статус подписчика `unsubscribed` + отображение HTML‑подтверждения.
8) Rate limit 5–8 писем/сек + batch size 50 соблюдаются, concurrency=1.
9) Ошибка отправки одной части батча → процесс продолжается, ошибки фиксируются.

## 5) Негативные кейсы
- Нет доступа к Supabase/SES → рассылка останавливается, статус Failed.
- Ошибка Notion API → запись в таблицу ошибок.
- Некорректный auth_token/shared secret → 401/403.
- Пустой список активных подписчиков → корректный отчёт без отправки.
- Некорректная подпись Notion webhook → отказ в обработке.
- Некорректная SNS подпись/Topic ARN → событие игнорируется.
- Невалидный mailout_id → 400/404.

## 6) Критерии приёмки
- Нет дублей писем (кроме теста).
- Статусы подписчиков и mailout корректно обновляются.
- Отчёт и ошибки фиксируются в Notion; CSV сформирован.
- Все E2E проходят; критические флоу проверены вручную (DoD).

## 7) Наборы данных/фикстуры
- `subscribers`: минимум 1 active, 1 unsubscribed, 1 bounced; разные домены.
- `mailouts`: 1 ready (для отправки), 1 sent (для проверки idempotency).
- Тестовые токены: валидный/невалидный auth_token, валидный/невалидный SNS/Notion подписи.
- TEST_EMAILS: список 2–3 адресов.

## 8) Проверки по типам тестов (минимум)
- Unit: парсер TEST_EMAILS; генерация footer; подписи Notion/SNS; преобразование контента (Notion blocks → HTML/text).
- Integration: мок Notion + Supabase + SES; проверка статусов mailout/subscribers; запись ошибок в Notion/CSV.
- E2E: реальная отправка в тестовом режиме на TEST_EMAILS; симуляция SNS Bounce/Complaint.
- Manual: сверка Notion таблиц («Письма»/«Ошибки»), статусов и отчётов после прогона.

## 9) Пробелы/неясности (фиксируем явно)
- Нет `docs/tech-spec-ru.md`; ТЗ взято из `spec_001.md`, возможны расхождения с актуальной реализацией.
- `framework/review/handoff.md` пуст: неизвестны команды запуска, окружение, конкретный commit/branch.
- Не описан точный формат CSV отчёта и полей в Notion таблицах (кроме общих указаний).
- Не указано, есть ли `mailouts` в Supabase или статус хранится в Notion — требуется уточнение для точного набора тестов.
- Не описано, как обрабатываются partial failures (retry/backoff) и какие коды ошибок возвращаются.
